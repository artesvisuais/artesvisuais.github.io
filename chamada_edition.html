<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Retificar Registro - Chamada Digital</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f7f7;
  margin: 0;
  padding: 15px;
}

h2 {
  text-align: center;
  margin-top: 50px;
  margin-bottom: 15px;
}

/* MENU */
.menu-mobile {
  cursor: pointer;
  display: inline-block;
  padding: 10px;
  position: absolute;
  top: 10px;
  left: 10px;
}

.bar {
  width: 25px;
  height: 3px;
  background-color: #333;
  margin: 4px 0;
  border-radius: 2px;
}

.side-menu {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 100;
  top: 0;
  left: 0;
  background-color: #fff;
  overflow-x: hidden;
  transition: 0.4s;
  padding-top: 60px;
  box-shadow: 2px 0 5px rgba(0,0,0,0.2);
}

.side-menu a {
  padding: 15px 25px;
  text-decoration: none;
  font-size: 20px;
  color: #333;
  display: block;
  border-bottom: 1px solid #eee;
}

.btn-voltar-menu {
  display: inline-block;
  transform: rotate(180deg);
  font-size: 30px !important;
  color: #d9534f !important;
  padding: 10px 25px !important;
  border-bottom: none !important;
}

/* CONTROLES */
#top-controls {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

#top-controls > * {
  flex: 1;
}

select, input {
  padding: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

/* CARDS */
.aluno {
  background: #fff;
  border-radius: 10px;
  margin: 8px 0;
  padding: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: 0.2s;
}

.transferido {
  opacity: 0.4;
  color: #555;
}

.botoes {
  margin-top: 8px;
  display: flex;
  justify-content: space-between;
}

.botoes button {
  flex: 1;
  margin: 0 2px;
  padding: 10px;
  border: none;
  border-radius: 6px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

.botoes button:disabled {
  cursor: not-allowed;
  opacity: 0.6;
}

.btnA { background: #B0E0E6; }
.btnF { background: #d9534f; }
.btn1 { background: #f0ad4e; }
.btn2 { background: #5bc0de; }
.btn3 { background: #5cb85c; }
.btnDel { background: #444; }

.botoes button.selecionado {
  box-shadow: 0 0 8px 3px #333 inset;
  transform: scale(1.2);
  z-index: 1;
  position: relative;
}

/* CONFIRMA√á√ÉO */
.confirm-box {
  margin-top: 10px;
  background: #f8f9fa;
  padding: 8px;
  border-radius: 6px;
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.confirm-box button {
  width: auto;
  padding: 6px 10px;
  margin-left: 6px;
  font-size: 14px;
}

.btnConfirm { background: #5cb85c; color: white; border: none; }
.btnCancel { background: #d9534f; color: white; border: none; }

#status {
  text-align: center;
  margin-top: 10px;
  font-weight: bold;
}

.info-turma {
  margin-top: 8px;
  padding: 6px 10px;
  background: #f0f8ff;
  border-left: 4px solid #5bc0de;
  border-radius: 6px;
  font-weight: bold;
  font-size: 15px;
  color: #333;
}
</style>
</head>

<body>

<div class="menu-mobile" onclick="toggleMenu()">
  <div class="bar"></div>
  <div class="bar"></div>
  <div class="bar"></div>
</div>

<div id="side-menu" class="side-menu">
  <a href="#" class="btn-voltar-menu" onclick="toggleMenu()">‚ûú</a> 
  <a href="https://artesvisuais.github.io/chamada_index.html">üè† Voltar para Chamada</a>
  <a href="#" onclick="marcarTodosNaoLetivo()">Marcar<br> (N√£o Letivo)üö´</a>
</div>

<h2>Retificar Registro</h2>

<div id="top-controls">
  <select id="turma" onchange="atualizarInfoTurma(); atualizarListaAlunos();">
    <option value="">-- Turma --</option>
    <option value="1E">1E</option>
    <option value="2G">2G</option>
    <option value="3E">3E</option>
    <option value="5E">5E</option>
    <option value="5F">5F</option>
    <option value="4A">4A</option>
    <option value="4B">4B</option>
    <option value="5A">5A</option>
    <option value="5B">5B</option>
    <option value="5C">5C</option>
    <option value="5DD">5DD</option>
    <option value="EJA1">EJA1</option>
    <option value="EJA2">EJA2</option>
  </select>

  <input type="date" id="data">
</div>
<div id="infoTurma" class="info-turma"></div>
<div id="status"></div>
<div id="listaEdicao"></div>

<script>

const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyZTRtxAcPdj-qx0IC9bJ_yWELubfsPJEpUPFrqL5tYe2YPzZ3k98ReEB4kIe--ZA/exec";

function toggleMenu() {
  const menu = document.getElementById("side-menu");
  menu.style.width = (menu.style.width === "250px") ? "0" : "250px";
}

function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = '_cb' + Math.random().toString(36).substr(2, 9);
    window[cb] = (d) => { resolve(d); delete window[cb]; document.getElementById(cb)?.remove(); };
    const s = document.createElement('script');
    s.src = url + (url.indexOf('?') === -1 ? '?' : '&') + 'callback=' + cb;
    s.id = cb;
    s.onerror = reject;
    document.body.appendChild(s);
  });
}

async function atualizarListaAlunos() {

  const turma = document.getElementById("turma").value;
  const dataVal = document.getElementById("data").value;
  const st = document.getElementById("status");

  if (!turma || !dataVal) return;

  const partes = dataVal.split("-");
  st.innerText = "Carregando estudantes...";
  st.style.color = "orange";

  try {

    const resp = await jsonp(`${URL_SCRIPT}?turma=${turma}&dia=${parseInt(partes[2])}&mes=${parseInt(partes[1])}`);

    const lista = document.getElementById("listaEdicao");
    lista.innerHTML = "";

    resp.registros.forEach(a => {

      const div = document.createElement("div");
      div.className = "aluno";
      div.id = `aluno-${a.id}`;

      if (a.nome.startsWith('*')) {
        div.classList.add("transferido");
      }

      const valorAtual = (a.valor !== undefined && a.valor !== null) ? String(a.valor) : "";

      div.innerHTML = `
        <strong>${a.nome}</strong><br>
        <small>Atual: ${valorAtual || "Vazio"}</small>

        <div class="botoes">
          <button class="btnA" data-valor="A">A</button>
          <button class="btnF" data-valor="F">F</button>
          <button class="btn1" data-valor="1">1</button>
          <button class="btn2" data-valor="2">2</button>
          <button class="btn3" data-valor="3">3</button>
          <button class="btnDel" data-valor="">üóë</button>
        </div>

        <div id="confirm-${a.id}"></div>
      `;

      lista.appendChild(div);

      const botoes = div.querySelectorAll(".botoes button");

      botoes.forEach(btn => {

        if (valorAtual === btn.getAttribute("data-valor")) {
          btn.classList.add("selecionado");
        }

        if (a.nome.startsWith('*')) {
          btn.disabled = true;
        } else {
          btn.addEventListener("click", () => {
            prepararConfirmacao(turma, a.id, btn.getAttribute("data-valor"));
          });
        }

      });

    });

    st.innerText = "Lista carregada!";
    st.style.color = "green";

  } catch {
    st.innerText = "Erro ao carregar.";
    st.style.color = "red";
  }
}

function prepararConfirmacao(turma, id, valor) {

  const box = document.getElementById(`confirm-${id}`);
  const texto = valor === "" ? "APAGAR REGISTRO" : valor;

  box.innerHTML = `
    <div class="confirm-box">
      Confirmar altera√ß√£o para <strong>${texto}</strong>?
      <div>
        <button class="btnConfirm" onclick="executarRetificacao('${turma}', ${id}, '${valor}')">‚úî</button>
        <button class="btnCancel" onclick="cancelarConfirmacao(${id})">‚úñ</button>
      </div>
    </div>
  `;
}

function cancelarConfirmacao(id) {
  document.getElementById(`confirm-${id}`).innerHTML = "";
}

async function executarRetificacao(turma, id, valor) {

  const dataVal = document.getElementById("data").value;
  const st = document.getElementById("status");
  const partes = dataVal.split("-");

  st.innerText = "Salvando...";
  st.style.color = "blue";

  try {

    const resp = await jsonp(`${URL_SCRIPT}?turma=${turma}&id=${id}&valor=${valor}&dia=${parseInt(partes[2])}&mes=${parseInt(partes[1])}`);

    if (resp.ok || !resp.erro) {
      st.innerText = "Retificado com sucesso!";
      st.style.color = "green";
      atualizarListaAlunos();
    } else {
      st.innerText = "Erro: " + resp.erro;
      st.style.color = "red";
    }

  } catch {
    st.innerText = "Falha ao salvar.";
    st.style.color = "red";
  }
}

// Mapa fixo de turmas -> professores
const PROFESSORES = {
  "1E": "Prof¬™ Liliane",
  "2G": "Prof¬™ Renata",
  "3E": "Prof¬™ Marta",
  "4A": "Prof¬™ Margareth",
  "4B": "Prof¬™ Simone",
  "5A": "Prof¬™ Tania Morais",
  "5B": "Prof¬™ Flavia",
  "5C": "Prof¬™ Erika",
  "5E": "Prof¬™ Liza",
  "5F": "Prof Lucas",
  "5DD": "Prof. Robson",
  "EJA1": "Prof. ",
  "EJA2": "Prof¬™ "
  // Adicione as demais turmas aqui
};

function atualizarInfoTurma() {
  const turma = document.getElementById("turma").value;
  const info = document.getElementById("infoTurma");

  if (!turma) {
    info.innerHTML = "";
    return;
  }

  const professor = PROFESSORES[turma];

  if (professor) {
    info.innerHTML = `
  <div style="font-size:14px;opacity:0.8;">Turma ${turma}</div>
  <div style="font-size:16px;">üë©‚Äçüè´ ${professor}</div>
`;
  } else {
    info.innerHTML = "üë©‚Äçüè´ Regente n√£o cadastrado";
  }
}
  function marcarTodosNaoLetivo() {
  // Seleciona todos os bot√µes que possuem a classe btnA (Bot√£o A)
  const botoesA = document.querySelectorAll('.btnA');
  
  if (botoesA.length === 0) {
    alert("Carregue uma turma primeiro!");
    return;
  }

  // Confirma√ß√£o para evitar cliques acidentais
  if (confirm("Deseja marcar TODOS os alunos como 'A' (N√£o Letivo)?")) {
    botoesA.forEach(botao => {
      // S√≥ clica se o bot√£o n√£o estiver desativado (para respeitar transferidos)
      if (!botao.disabled) {
        botao.click();
      }
    });
    toggleMenu(); // Fecha o menu lateral ap√≥s a a√ß√£o
  }
}

document.getElementById("turma").addEventListener("change", atualizarListaAlunos);
document.getElementById("data").addEventListener("change", atualizarListaAlunos);

</script>

</body>
</html>






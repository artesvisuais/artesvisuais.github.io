<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Anotações_v35</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #fff;
    }

    /* ---------- BOTÕES ---------- */
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 4px;
      transition: 0.2s;
    }
    button:hover { background-color: #45a049; }

    .btnExcluir {
      background-color: #d9534f;
    }
    .btnExcluir:hover {
      background-color: #c9302c;
    }

    /* ---------- FORM NOVA ANOTAÇÃO ---------- */
    #formularioNovo {
      display: none;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      background-color: #f9f9f9;
    }

    input[type="text"], textarea, select {
      font-size: 15px;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
    }

    /* ---------- LISTA DE ANOTAÇÕES (SEM TABELA) ---------- */
    #listaAnotacoes {
      margin-top: 20px;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .card-top {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }

    .card-top span {
      display: inline-block;
      margin-right: 10px;
      font-weight: bold;
    }

    .card-text {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 10px;
    }

    .card-editarea {
      width: 100%;
      display: none;
      margin-bottom: 10px;
    }

    .card-actions {
      margin-top: 10px;
    }

    /* ---------- PESQUISA ---------- */
    #pesquisaContainer {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #contadorResultados {
      color: #555;
      font-size: 13px;
    }

    /* ---------- RESPONSIVIDADE ---------- */
    @media (max-width: 768px) {
      body { font-size: 18px; margin: 10px; }

      button {
        padding: 10px;
        font-size: 18px;
        margin: 6px 2px;
      }

      .card { padding: 14px; }
      .card-top { font-size: 16px; }
      .card-text { font-size: 18px; }
      textarea { font-size: 18px; }
    }
  </style>
</head>
<body>

<button onclick="toggleFormulario()">Nova anotação</button>

<div id="formularioNovo">
  <h3>Inserir nova anotação</h3>

  <label>Categoria/Tópico:</label>
  <input type="text" id="novaCategoria" placeholder="Nova categoria...">

  <select id="selectCategoriaExistente" onchange="sincronizarCategoria()">
    <option value="">(ou selecione uma existente)</option>
  </select>

  <br><br>

  <label>Anotação:</label>
  <textarea id="novaAnotacao" rows="3"></textarea>

  <br><br>

  <button onclick="enviarNova()">Salvar</button>
  <button onclick="toggleFormulario()">Fechar</button>
</div>

<h3>Visualizar anotações por categoria</h3>

<select id="filtroCategoria" onchange="carregarAnotacoes()">
  <option value="">Selecione uma categoria</option>
</select>

<div id="pesquisaContainer">
  <input type="text" id="campoPesquisa" placeholder="Pesquisar..." oninput="filtrarTabela()">
  <button onclick="limparPesquisa()">Limpar</button>
  <span id="contadorResultados" style="display:none"></span>
</div>

<!-- AQUI ENTRAM OS CARDS (SEM TABELA) -->
<div id="listaAnotacoes"></div>



<script>
/* ------------------------------- SEU JS ORIGINAL (mantido)
   Apenas alterei a parte de preencherTabela()
   para criar DIVS em vez de Tabela.
-------------------------------- */

let categorias = [];
let anotacoes = [];
let anotacoesFiltradas = [];

/* ---------------- FORMULÁRIO ---------------- */
function toggleFormulario() {
  const div = document.getElementById('formularioNovo');
  div.style.display = div.style.display === 'none' ? 'block' : 'none';
  if (div.style.display === 'block') {
    preencherSelectCategoriasExistentes();
  }
}

function sincronizarCategoria() {
  const select = document.getElementById('selectCategoriaExistente');
  const input = document.getElementById('novaCategoria');
  if (select.value) input.value = select.value;
}

function transformarLinksEmHTML(texto) {
  if (!texto) return '';
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return texto.replace(urlRegex, url => {
    try {
      const u = new URL(url);
      return `<a href="${url}" target="_blank">${u.hostname.replace('www.', '')}</a>`;
    } catch {
      return url;
    }
  });
}

/* ---------------- CATEGORIAS ---------------- */
function carregarCategorias() {
  google.script.run.withSuccessHandler(function(cats) {
    categorias = cats || [];
    const filtro = document.getElementById('filtroCategoria');
    const catAtual = filtro.value;

    filtro.innerHTML = '<option value="">Selecione uma categoria</option>';
    categorias.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      if (cat === catAtual) option.selected = true;
      filtro.appendChild(option);
    });
  }).obterCategorias();
}

function preencherSelectCategoriasExistentes() {
  const select = document.getElementById('selectCategoriaExistente');
  select.innerHTML = '<option value="">(ou selecione uma existente)</option>';
  categorias.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });
}

/* ---------------- LISTAR ANOTAÇÕES ---------------- */
function carregarAnotacoes() {
  const filtro = document.getElementById('filtroCategoria').value;
  const lista = document.getElementById('listaAnotacoes');
  lista.innerHTML = '';
  document.getElementById('campoPesquisa').value = '';
  esconderContador();

  if (!filtro) return;

  google.script.run.withSuccessHandler(function(data) {
    anotacoes = data || [];
    anotacoesFiltradas = [...anotacoes];
    preencherCards(anotacoesFiltradas);
  }).obterAnotacoes(filtro);
}

/* ---------- AQUI É A NOVA LISTA (SEM TABELA) ---------- */
function preencherCards(dados) {
  const lista = document.getElementById('listaAnotacoes');
  lista.innerHTML = '';

  if (dados.length === 0) {
    lista.innerHTML = '<em>Nenhuma anotação encontrada.</em>';
    return;
  }

  dados.forEach(row => {
    const [data, hora, categoria, anotacao, linha] = row;

    const card = document.createElement('div');
    card.className = "card";

    /* Topo */
    const topo = document.createElement('div');
    topo.className = "card-top";
    topo.innerHTML = `
      <span>${categoria}</span>
      <span>${data}</span>
      <span>${hora}</span>
    `;

    /* Conteúdo */
    const texto = document.createElement('div');
    texto.className = "card-text";
    texto.innerHTML = transformarLinksEmHTML(anotacao);

    /* Textarea edição */
    const editArea = document.createElement('textarea');
    editArea.className = "card-editarea";
    editArea.rows = 3;
    editArea.value = anotacao;

    /* Botões */
    const actions = document.createElement('div');
    actions.className = "card-actions";

    const btnEditar = document.createElement('button');
    btnEditar.textContent = "Editar";

    const btnSalvar = document.createElement('button');
    btnSalvar.textContent = "Salvar";
    btnSalvar.style.display = "none";

    const btnCancelar = document.createElement('button');
    btnCancelar.textContent = "Cancelar";
    btnCancelar.className = "btnExcluir";
    btnCancelar.style.display = "none";

    const btnExcluir = document.createElement('button');
    btnExcluir.textContent = "Excluir";
    btnExcluir.className = "btnExcluir";


    /* --- EVENTOS --- */
    btnEditar.onclick = () => {
      texto.style.display = "none";
      editArea.style.display = "block";
      btnEditar.style.display = "none";
      btnSalvar.style.display = "inline-block";
      btnCancelar.style.display = "inline-block";
    };

    btnCancelar.onclick = () => {
      editArea.value = anotacao;
      texto.style.display = "block";
      editArea.style.display = "none";
      btnEditar.style.display = "inline-block";
      btnSalvar.style.display = "none";
      btnCancelar.style.display = "none";
    };

    btnSalvar.onclick = () => {
      const novaAnot = editArea.value.trim();
      if (!novaAnot) { alert("Anotação vazia!"); return; }

      google.script.run.withSuccessHandler(() => {
        alert("Atualizado!");
        carregarCategorias();
        setTimeout(carregarAnotacoes, 200);
      }).atualizarAnotacao(linha, categoria, novaAnot);
    };

    btnExcluir.onclick = () => {
      if (confirm("Excluir esta anotação?")) {
        google.script.run.withSuccessHandler(() => {
          alert("Excluída!");
          carregarCategorias();
          setTimeout(carregarAnotacoes, 200);
        }).excluirAnotacao(linha);
      }
    };

    actions.appendChild(btnEditar);
    actions.appendChild(btnSalvar);
    actions.appendChild(btnCancelar);
    actions.appendChild(btnExcluir);

    /* Montagem final */
    card.appendChild(topo);
    card.appendChild(texto);
    card.appendChild(editArea);
    card.appendChild(actions);

    lista.appendChild(card);
  });
}

/* ---------------- PESQUISA ---------------- */
function filtrarTabela() {
  const termo = document.getElementById('campoPesquisa').value.trim().toLowerCase();
  const contador = document.getElementById('contadorResultados');

  if (!termo) {
    anotacoesFiltradas = [...anotacoes];
    preencherCards(anotacoesFiltradas);
    esconderContador();
    return;
  }

  const filtradas = anotacoes.filter(row => {
    const texto = (row[3] || '') + ' ' + (row[2] || '');
    return texto.toLowerCase().includes(termo);
  });

  anotacoesFiltradas = filtradas;
  preencherCards(filtradas);

  contador.style.display = "inline";
  contador.textContent = filtradas.length + " resultados";
}

function limparPesquisa() {
  document.getElementById('campoPesquisa').value = '';
  filtrarTabela();
}

function esconderContador() {
  document.getElementById('contadorResultados').style.display = 'none';
}


/* ---------------- ENVIAR NOVA ---------------- */
function enviarNova() {
  const categoria = document.getElementById('novaCategoria').value.trim();
  const anotacao = document.getElementById('novaAnotacao').value.trim();

  if (!anotacao) {
    alert('Insira uma anotação.');
    return;
  }

  google.script.run.withSuccessHandler(() => {
    alert("Salvo!");
    document.getElementById('novaCategoria').value = '';
    document.getElementById('selectCategoriaExistente').value = '';
    document.getElementById('novaAnotacao').value = '';
    toggleFormulario();
    carregarCategorias();
    setTimeout(carregarAnotacoes, 300);
  }).salvarAnotacao(categoria, anotacao);
}

window.onload = carregarCategorias;
</script>

</body>
</html>
